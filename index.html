<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ç™»å½• - TOFDç„Šç¼ç¼ºé™·æ£€æµ‹</title>

  <!-- æ–¹æ¡ˆAï¼šå›ºå®šæœåŠ¡å™¨åœ°å€ï¼ˆå±€åŸŸç½‘ C/Sï¼šç”¨æˆ·æ— éœ€å¡«å†™ï¼‰ -->
  <script>
    // âœ… æ‰“åŒ…å‰æŠŠè¿™é‡Œæ”¹æˆä½ çš„æœåŠ¡å™¨ç”µè„‘å±€åŸŸç½‘IPï¼Œä¾‹å¦‚ï¼šhttp://192.168.1.10:8000
    window.__APP_CONFIG__ = {
      API_BASE: "http://192.168.160.1:8000"
    };
  </script>

 <script src="./libs/vue.global.prod.js"></script>

  <!-- å¤ç”¨åŸæœ‰æ ·å¼ -->
  <link rel="stylesheet" href="login.css" />
</head>

<body>
<div id="app">
  <div class="card" :class="{ 'card-shake': loginError }">
    <div class="logo">
      <span class="logo-icon">ğŸ”</span>
      <h1>TOFD ç„Šç¼ç¼ºé™·æ£€æµ‹</h1>
    </div>

    <!-- é¡¶éƒ¨ï¼šç”¨æˆ·å…¥å£ / ç®¡ç†å‘˜å…¥å£ -->
    <div class="tab-switch">
      <button
        class="tab-btn"
        :class="{ 'tab-btn--active': activeTab === 'user' }"
        @click="switchTab('user')"
      >
        ç”¨æˆ·å…¥å£
      </button>
      <button
        class="tab-btn"
        :class="{ 'tab-btn--active': activeTab === 'admin' }"
        @click="switchTab('admin')"
      >
        ç®¡ç†å‘˜å…¥å£
      </button>
    </div>

    <!-- ç”¨æˆ·å…¥å£ï¼šç™»å½•  -->
    <div v-if="activeTab === 'user'">
      <div class="mode-switch">
        <button
          class="mode-btn"
          :class="{ 'mode-btn--active': userMode === 'login' }"
          @click="userMode = 'login'"
        >
          ç™»å½•
        </button>
      </div>

      <div class="form-group">
        <label for="user">ç”¨æˆ·å</label>
        <input
          id="user"
          type="text"
          placeholder="è¯·è¾“å…¥ç”¨æˆ·å"
          v-model="username"
          @keyup.enter="handleUserSubmit"
          :class="{ 'input-error': userUsernameError }"
        >
        <span class="error">{{ userUsernameError }}</span>
      </div>

      <div class="form-group">
        <label for="pass">å¯†ç </label>
        <input
          id="pass"
          type="password"
          placeholder="è¯·è¾“å…¥å¯†ç "
          v-model="password"
          @keyup.enter="handleUserSubmit"
          :class="{ 'input-error': userPasswordError }"
        >
        <span class="error">{{ userPasswordError }}</span>
      </div>

      <div class="form-group" v-if="userMode === 'register'">
        <label for="pass2">ç¡®è®¤å¯†ç </label>
        <input
          id="pass2"
          type="password"
          placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç "
          v-model="confirmPassword"
          @keyup.enter="handleUserSubmit"
          :class="{ 'input-error': userConfirmError }"
        >
        <span class="error">{{ userConfirmError }}</span>
      </div>

      <button class="btn" @click="handleUserSubmit" :disabled="isLoading">
        <span v-if="isLoading" class="loading"></span>
        <span v-if="!isLoading">
          {{ userMode === 'login' ? 'ç™»å½•' : 'æ³¨å†Œ' }}
        </span>
        <span v-else>
          {{ userMode === 'login' ? 'ç™»å½•ä¸­...' : 'æ³¨å†Œä¸­...' }}
        </span>
      </button>
    </div>

    <!-- ç®¡ç†å‘˜å…¥å£ï¼šä»…ç™»å½• -->
    <div v-else>
      <div class="form-group">
        <label for="admin-user">ç®¡ç†å‘˜è´¦å·</label>
        <input
          id="admin-user"
          type="text"
          placeholder="è¯·è¾“å…¥ç®¡ç†å‘˜è´¦å·"
          v-model="adminUsername"
          @keyup.enter="handleAdminLogin"
          :class="{ 'input-error': adminUsernameError }"
        >
        <span class="error">{{ adminUsernameError }}</span>
      </div>

      <div class="form-group">
        <label for="admin-pass">ç®¡ç†å‘˜å¯†ç </label>
        <input
          id="admin-pass"
          type="password"
          placeholder="è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç "
          v-model="adminPassword"
          @keyup.enter="handleAdminLogin"
          :class="{ 'input-error': adminPasswordError }"
        >
        <span class="error">{{ adminPasswordError }}</span>
      </div>

      <button class="btn" @click="handleAdminLogin" :disabled="isLoading">
        <span v-if="isLoading" class="loading"></span>
        {{ isLoading ? 'ç™»å½•ä¸­...' : 'ç®¡ç†å‘˜ç™»å½•' }}
      </button>
    </div>

    <div v-if="successMessage" class="success-message">
      {{ successMessage }}
    </div>

    <span class="muted">
      ç”¨æˆ·å…¥å£æ”¯æŒç™»å½•ä¸æ³¨å†Œï¼›ç®¡ç†å‘˜è¯·ä½¿ç”¨ç®¡ç†å‘˜å…¥å£ç™»å½•ã€‚
    </span>
  </div>
</div>

<script>
  const { createApp, ref, computed } = Vue;

  const API = (window.__APP_CONFIG__ && window.__APP_CONFIG__.API_BASE)
    ? window.__APP_CONFIG__.API_BASE
    : "http://127.0.0.1:8000";

  createApp({
    setup() {
      const activeTab = ref('user');       // user / admin
      const userMode = ref('login');       // login / register

      // ç”¨æˆ·ç«¯
      const username = ref('');
      const password = ref('');
      const confirmPassword = ref('');

      // ç®¡ç†å‘˜ç«¯
      const adminUsername = ref('');
      const adminPassword = ref('');

      const isLoading = ref(false);
      const loginError = ref(false);
      const successMessage = ref('');

      const shakeCard = () => {
        loginError.value = true;
        setTimeout(() => (loginError.value = false), 400);
      };

      const clearMessage = () => {
        successMessage.value = '';
      };

      const switchTab = (tab) => {
        activeTab.value = tab;
        clearMessage();
        loginError.value = false;
      };

      // ============ ç”¨æˆ·ç«¯è¡¨å•æ ¡éªŒ ============
      const userUsernameError = computed(() => {
        if (activeTab.value !== 'user') return '';
        if (!username.value.trim()) return 'è¯·è¾“å…¥ç”¨æˆ·å';
        if (username.value.trim().length < 3) return 'ç”¨æˆ·åè‡³å°‘ 3 ä¸ªå­—ç¬¦';
        return '';
      });

      const userPasswordError = computed(() => {
        if (activeTab.value !== 'user') return '';
        if (!password.value) return 'è¯·è¾“å…¥å¯†ç ';
        if (password.value.length < 4) return 'å¯†ç è‡³å°‘ 4 ä¸ªå­—ç¬¦';
        return '';
      });

      const userConfirmError = computed(() => {
        if (activeTab.value !== 'user' || userMode.value !== 'register') return '';
        if (!confirmPassword.value) return 'è¯·å†æ¬¡è¾“å…¥å¯†ç ';
        if (confirmPassword.value !== password.value) return 'ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´';
        return '';
      });

      // ============ ç®¡ç†å‘˜è¡¨å•æ ¡éªŒ ============
      const adminUsernameError = computed(() => {
        if (activeTab.value !== 'admin') return '';
        if (!adminUsername.value.trim()) return 'è¯·è¾“å…¥ç®¡ç†å‘˜è´¦å·';
        return '';
      });

      const adminPasswordError = computed(() => {
        if (activeTab.value !== 'admin') return '';
        if (!adminPassword.value) return 'è¯·è¾“å…¥å¯†ç ';
        return '';
      });

      // ============ ç”¨æˆ·ç™»å½• / æ³¨å†Œ ============
      const handleUserSubmit = async () => {
        if (userUsernameError.value || userPasswordError.value || userConfirmError.value) {
          shakeCard();
          return;
        }

        isLoading.value = true;
        clearMessage();

        try {
          const fd = new FormData();
          fd.append('username', username.value.trim());
          fd.append('password', password.value);

          const url = userMode.value === 'login' ? '/api/login' : '/api/register';
          const r = await fetch(API + url, { method: 'POST', body: fd });
          const j = await r.json().catch(() => ({ error: 'ç½‘ç»œé”™è¯¯' }));

          if (!r.ok) {
            throw new Error(j.error || (userMode.value === 'login' ? 'ç™»å½•å¤±è´¥' : 'æ³¨å†Œå¤±è´¥'));
          }

          localStorage.setItem('yolo_token', j.token || '');
          localStorage.setItem('yolo_user', j.username || username.value.trim());
          localStorage.setItem('yolo_role', j.role || 'user');

          successMessage.value =
            userMode.value === 'login'
              ? `ç™»å½•æˆåŠŸï¼æ¬¢è¿ ${j.username || username.value.trim()}`
              : `æ³¨å†ŒæˆåŠŸå¹¶å·²ç™»å½•ï¼æ¬¢è¿ ${j.username || username.value.trim()}`;

          setTimeout(() => {
            location.href = 'main.html';
          }, 800);
        } catch (err) {
          shakeCard();
          successMessage.value = '';
          alert(err.message || String(err));
        } finally {
          isLoading.value = false;
        }
      };

      // ============ ç®¡ç†å‘˜ç™»å½• ============
      const handleAdminLogin = async () => {
        if (adminUsernameError.value || adminPasswordError.value) {
          shakeCard();
          return;
        }

        isLoading.value = true;
        clearMessage();

        try {
          const fd = new FormData();
          fd.append('username', adminUsername.value.trim());
          fd.append('password', adminPassword.value);

          const r = await fetch(API + '/api/login', { method: 'POST', body: fd });
          const j = await r.json().catch(() => ({ error: 'ç½‘ç»œé”™è¯¯' }));

          if (!r.ok) {
            throw new Error(j.error || 'ç™»å½•å¤±è´¥');
          }
          if (j.role !== 'admin') {
            throw new Error('è¯¥è´¦å·ä¸æ˜¯ç®¡ç†å‘˜');
          }

          localStorage.setItem('yolo_token', j.token || '');
          localStorage.setItem('yolo_user', j.username || adminUsername.value.trim());
          localStorage.setItem('yolo_role', j.role || 'admin');

          successMessage.value = `ç®¡ç†å‘˜ç™»å½•æˆåŠŸï¼š${j.username || adminUsername.value.trim()}`;

          setTimeout(() => {
            location.href = 'admin.html';
          }, 800);
        } catch (err) {
          shakeCard();
          successMessage.value = '';
          alert(err.message || String(err));
        } finally {
          isLoading.value = false;
        }
      };

      return {
        activeTab, userMode,
        username, password, confirmPassword,
        adminUsername, adminPassword,
        isLoading, loginError, successMessage,

        switchTab,
        userUsernameError, userPasswordError, userConfirmError,
        adminUsernameError, adminPasswordError,

        handleUserSubmit,
        handleAdminLogin,
      };
    }
  }).mount('#app');
</script>
</body>
</html>
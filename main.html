<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TOFD ç„Šç¼ç¼ºé™·æ£€æµ‹</title>

  <!-- æ–¹æ¡ˆAï¼šå›ºå®šæœåŠ¡å™¨åœ°å€ï¼ˆå±€åŸŸç½‘ C/Sï¼šç”¨æˆ·æ— éœ€å¡«å†™ï¼‰ -->
  <script>
    // âœ… æ‰“åŒ…å‰æŠŠè¿™é‡Œæ”¹æˆä½ çš„æœåŠ¡å™¨ç”µè„‘å±€åŸŸç½‘IPï¼Œä¾‹å¦‚ï¼šhttp://192.168.1.10:8000
    window.__APP_CONFIG__ = { API_BASE: "http://192.168.160.1:8000" };
  </script>

  <!-- Vue3ï¼šæœ¬åœ°éƒ¨ç½²ï¼ˆä¼˜å…ˆ libsï¼Œå…¶æ¬¡ vendorï¼‰ -->
  <script src="./libs/vue.global.prod.js"></script>
  <script>
    if (!window.Vue) document.write('<script src="./vendor/vue.global.prod.js"><\/script>');
  </script>

  <link rel="stylesheet" href="main.css" />

  <style>
    .top-nav { display:flex; gap:10px; align-items:center; margin-left:14px; }
    .top-nav .link-btn { padding: 8px 12px; border-radius: 12px; }
    .top-nav .link-btn.active { background: rgba(59, 130, 246, .12); }
    .result-actions { display:flex; gap:10px; align-items:center; justify-content:flex-end; flex-wrap:wrap; }
    .pill { font-size:12px; padding:4px 10px; border-radius:999px; background:rgba(59,130,246,.10); color:#2563eb; }
    .hint { font-size:12px; color: rgba(0,0,0,.55); }
  </style>
</head>

<body>
<div id="app">
  <header class="app-header">
    <div class="app-title">
      <div>
        <h1>TOFD ç„Šç¼ç¼ºé™·æ£€æµ‹</h1>
        <p class="subtitle">é€‰æ‹©ç„Šç¼å›¾ï¼Œç‚¹å‡»ä¸€æ¬¡æŒ‰é’®ï¼Œè‡ªåŠ¨å®Œæˆæ£€æµ‹</p>
      </div>

      <div class="top-nav">
        <button class="link-btn active" @click="goMain">æ£€æµ‹</button>
        <button class="link-btn" @click="goHistory">å†å²è®°å½•</button>
      </div>
    </div>

    <div class="user-area">
      <span class="user-name">æ‚¨å¥½ï¼Œ{{ username }}</span>
      <button class="link-btn" @click="logout">é€€å‡ºç™»å½•</button>
    </div>
  </header>

  <main class="app-main" v-if="token">
    <section class="panel primary-panel">
      <h2 class="panel-title">ä¸€æ­¥å®Œæˆç¼ºé™·æ£€æµ‹</h2>
      <p class="panel-desc">
        ç¬¬ä¸€æ­¥ï¼šæŠŠç„Šç¼å›¾æ‹–è¿›æ¥æˆ–ç‚¹å‡»é€‰æ‹©<br>
        ç¬¬äºŒæ­¥ï¼šç‚¹å‡»â€œå¼€å§‹æ£€æµ‹â€<br>
        æ£€æµ‹å®Œæˆåï¼Œç‚¹å‡»æ–‡ä»¶åˆ—è¡¨å¯å¿«é€Ÿå®šä½ç»“æœã€‚
      </p>

      <div class="upload-area"
           :class="{ 'upload-area--active': dragOver }"
           @click="openFileDialog"
           @dragover.prevent="onDragOver"
           @dragleave.prevent="onDragLeave"
           @drop.prevent="onDrop">
        <input type="file" ref="fileInput" multiple accept="image/*" @change="onFileChange" hidden>
        <div class="upload-icon">â¬†ï¸</div>
        <p class="upload-main-text">ç‚¹å‡»è¿™é‡Œé€‰æ‹©ç„Šç¼å›¾ï¼Œæˆ–æŠŠå›¾ç‰‡æ‹–åˆ°è¿™é‡Œ</p>
        <p class="upload-sub-text">æ”¯æŒå¤šå¼ å›¾ç‰‡ï¼ˆJPG / PNG ç­‰ï¼‰</p>
      </div>

      <div class="preview-wrapper" v-if="selectedFiles.length">
        <h3 class="small-title">å·²é€‰æ‹©çš„å›¾ç‰‡ï¼ˆ{{ selectedFiles.length }}ï¼‰</h3>
        <div class="preview-list">
          <div class="preview-item" v-for="(file, idx) in selectedFiles" :key="idx">
            <div class="preview-thumb" v-if="file.previewUrl">
              <img :src="file.previewUrl" :alt="file.name" title="ç‚¹å‡»æ”¾å¤§æŸ¥çœ‹"
                   @click.stop="openZoom(file.previewUrl)">
            </div>
            <div class="preview-info" @click="scrollToResult(idx)" title="ç‚¹å‡»å®šä½å³ä¾§æ£€æµ‹ç»“æœ">
              <div class="preview-name">{{ file.name }}</div>
              <div class="preview-meta">
                {{ humanSize(file.size) }}
                <span v-if="file.width && file.height"> Â· {{ file.width }}Ã—{{ file.height }}</span>
                <span style="color: var(--accent); margin-left: 6px; font-weight: bold;">ğŸ‘‰ å®šä½ç»“æœ</span>
              </div>
            </div>
            <button class="btn-small danger" @click.stop="removeFile(idx)">ç§»é™¤</button>
          </div>
        </div>
      </div>

      <button class="btn-primary main-action-btn" :disabled="!selectedFiles.length || isBusy"
              @click="runDetection">
        <span v-if="isBusy">æ­£åœ¨ä¸Šä¼ å¹¶æ£€æµ‹ï¼Œè¯·ç¨å€™â€¦</span>
        <span v-else-if="!selectedFiles.length">è¯·é€‰æ‹©ç„Šç¼å›¾ç‰‡åå†å¼€å§‹æ£€æµ‹</span>
        <span v-else>å¼€å§‹æ£€æµ‹</span>
      </button>

      <p v-if="statusMessage" :class="['status-banner', statusType]">{{ statusMessage }}</p>

      <details class="advanced" v-if="showAdvanced">
        <summary>é«˜çº§é€‰é¡¹ï¼ˆå¯é€‰ï¼‰</summary>
        <div class="advanced-content">
          <label class="field">
            <span class="field-label">ç½®ä¿¡åº¦é˜ˆå€¼</span>
            <div class="range-row">
              <input type="range" min="0.1" max="0.9" step="0.05" v-model.number="conf">
              <span class="range-value">{{ conf.toFixed(2) }}</span>
            </div>
          </label>
          <label class="field folder-field">
            <span class="field-label">é€‰æ‹©æ•´ä¸ªæ–‡ä»¶å¤¹</span>
            <input type="file" webkitdirectory multiple @change="onFolderChange">
          </label>
        </div>
      </details>
    </section>

    <section class="panel result-panel">
      <div class="result-header">
        <div class="result-header-left">
          <h2 class="panel-title">æœ¬æ¬¡æ£€æµ‹ç»“æœ</h2>
          <div class="hint" style="margin-top:6px;">
            æœåŠ¡å™¨ï¼š{{ API }} <span class="pill" title="å½“å‰å±•ç¤ºå†…å®¹æ¥æº">{{ viewSourceText }}</span>
          </div>
        </div>

        <div class="result-header-right result-actions">
          <span class="tag-count">å…± {{ detections.length }} å¼ </span>

          <button class="btn-small" :disabled="!detections.length" @click="exportCurrent">
            å¯¼å‡ºå½“å‰ç»“æœ
          </button>

          <button class="btn-small"
                  v-if="currentHistoryId"
                  :disabled="!detections.length"
                  @click="exportAsHistory">
            å¯¼å‡ºè¯¥æ¡å†å²
          </button>

          <button class="link-btn" @click="goHistory">å»å†å²è®°å½•é¡µ</button>
        </div>
      </div>

      <div v-if="isPredicting" class="result-empty">
        <div class="result-icon">â³</div>
        <p>æ­£åœ¨åˆ†æå›¾åƒå¹¶æ ‡å‡ºç„Šç¼ç¼ºé™·â€¦</p>
      </div>

      <div v-else-if="detections.length" class="result-grid">
        <article
          class="result-card"
          v-for="(det, idx) in detections"
          :key="idx"
          :id="'result-card-' + idx"
        >
          <div class="result-image-wrapper">
            <img
              :src="decodeImageUrl(det.img_url)"
              :alt="det.filename"
              title="ç‚¹å‡»æ”¾å¤§æŸ¥çœ‹"
              @error="onImageError(idx)"
              @click="openZoom(decodeImageUrl(det.img_url))"
            >
          </div>
          <div class="result-info">
            <div class="result-title">å›¾ç‰‡ {{ idx + 1 }}</div>
            <div class="result-meta" style="color: var(--ink);">{{ det.filename }}</div>
            <p class="result-meta">
              æ£€æµ‹åˆ°ç¼ºé™·ï¼š<strong>{{ det.boxes ? det.boxes.length : 0 }}</strong>
            </p>
          </div>
        </article>
      </div>

      <div v-else class="result-empty">
        <p>è¿˜æ²¡æœ‰æ£€æµ‹ç»“æœ</p>
        <p class="hint">ä½ ä¹Ÿå¯ä»¥å»â€œå†å²è®°å½•â€é¡µé€‰æ‹©ä¸€æ¡è®°å½•ï¼Œç„¶åç‚¹â€œåœ¨æ£€æµ‹é¡µæŸ¥çœ‹â€ã€‚</p>
      </div>
    </section>
  </main>

  <main class="app-main" v-else>
    <section class="panel">
      <h2>ç™»å½•çŠ¶æ€å·²å¤±æ•ˆ</h2>
      <button class="btn-primary" @click="goLogin">è¿”å›ç™»å½•é¡µ</button>
    </section>
  </main>

  <div class="image-modal" v-if="previewImage" @click="closeZoom">
    <span class="image-modal-close" @click="closeZoom">&times;</span>
    <img :src="previewImage" alt="å…¨å±æŸ¥çœ‹" @click.stop>
  </div>
</div>

<script>
  const { createApp, ref, computed, onMounted } = Vue;

  const API = (window.__APP_CONFIG__ && window.__APP_CONFIG__.API_BASE)
    ? window.__APP_CONFIG__.API_BASE.replace(/\/+$/, '')
    : "http://127.0.0.1:8000";

  createApp({
    setup() {
      const username = ref(localStorage.getItem('yolo_user') || 'ç”¨æˆ·');
      const token = ref(localStorage.getItem('yolo_token') || '');

      const selectedFiles = ref([]);
      const dragOver = ref(false);
      const fileInput = ref(null);

      const isUploading = ref(false);
      const isPredicting = ref(false);
      const statusMessage = ref('');
      const statusType = ref('ok');

      const conf = ref(0.25);
      const detections = ref([]);
      const showAdvanced = ref(true);
      const previewImage = ref(null);

      const uploadSessionId = ref('');
      const currentHistoryId = ref(null);
      const currentHistoryTime = ref('');

      const isBusy = computed(() => isUploading.value || isPredicting.value);
      const viewSourceText = computed(() => currentHistoryId.value ? `å†å²è®°å½• #${currentHistoryId.value}` : 'æœ¬æ¬¡æ£€æµ‹');

      const setStatus = (msg, type = 'ok') => {
        statusMessage.value = msg;
        statusType.value = type === 'error' ? 'error' : 'ok';
        if (!msg) return;
        setTimeout(() => (statusMessage.value = ''), 4000);
      };

      const humanSize = (bytes) => {
        if (!bytes && bytes !== 0) return '';
        const units = ['B', 'KB', 'MB', 'GB'];
        let i = 0, num = bytes;
        while (num >= 1024 && i < units.length - 1) { num /= 1024; i++; }
        return num.toFixed(1) + ' ' + units[i];
      };

      const openZoom = (url) => { if (url) previewImage.value = url; };
      const closeZoom = () => { previewImage.value = null; };

      const decodeImageUrl = (url) => {
        if (!url) return '';
        if (/^https?:\/\//i.test(url)) return url;
        const clean = String(url).replace(/\\/g, '/');
        const path = clean.startsWith('/') ? clean : '/' + clean;
        return API + path;
      };

      const openFileDialog = () => { if (fileInput.value) fileInput.value.click(); };
      const onFileChange = (e) => { addFiles(Array.from(e.target.files || [])); e.target.value = ''; };
      const onFolderChange = (e) => { addFiles(Array.from(e.target.files || [])); e.target.value = ''; };
      const onDragOver = () => { dragOver.value = true; };
      const onDragLeave = () => { dragOver.value = false; };
      const onDrop = (e) => { dragOver.value = false; addFiles(Array.from(e.dataTransfer.files || [])); };

      const addFiles = (files) => {
        const imageFiles = files.filter(f => f.type.startsWith('image/'));
        if (!imageFiles.length) return setStatus('æ²¡æœ‰æ£€æµ‹åˆ°å›¾ç‰‡æ–‡ä»¶ã€‚', 'error');

        imageFiles.forEach(file => {
          const item = { raw: file, name: file.name, size: file.size, width: null, height: null, previewUrl: '' };
          const url = URL.createObjectURL(file);
          item.previewUrl = url;

          const img = new Image();
          img.onload = () => { item.width = img.naturalWidth; item.height = img.naturalHeight; };
          img.src = url;

          selectedFiles.value.push(item);
        });
        setStatus(`å·²é€‰æ‹© ${selectedFiles.value.length} å¼ å›¾ç‰‡ã€‚`, 'ok');
      };

      const removeFile = (idx) => {
        const [removed] = selectedFiles.value.splice(idx, 1);
        if (removed && removed.previewUrl) URL.revokeObjectURL(removed.previewUrl);
      };

      const scrollToResult = (idx) => {
        if (detections.value.length === 0) return setStatus('è¯·å…ˆç”Ÿæˆæˆ–åŠ è½½æ£€æµ‹ç»“æœã€‚', 'error');
        const targetFile = selectedFiles.value[idx];
        if (!targetFile) return;

        const resultIndex = detections.value.findIndex(det => det.filename === targetFile.name);
        if (resultIndex !== -1) {
          const el = document.getElementById('result-card-' + resultIndex);
          if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        } else {
          setStatus(`ç»“æœä¸­æœªæ‰¾åˆ°æ–‡ä»¶ï¼š${targetFile.name}`, 'error');
        }
      };

      // ========= æ ¸å¿ƒï¼šsession_id ç‰ˆæœ¬ ä¸Šä¼  + æ£€æµ‹ =========
      const runDetection = async () => {
        if (!token.value) return setStatus('ç™»å½•çŠ¶æ€å¤±æ•ˆã€‚', 'error');
        if (!selectedFiles.value.length) return setStatus('è¯·å…ˆé€‰æ‹©å›¾ç‰‡ã€‚', 'error');

        detections.value = [];
        uploadSessionId.value = '';
        currentHistoryId.value = null;
        currentHistoryTime.value = '';

        try {
          // 1) ä¸Šä¼ ï¼šè¿”å› session_id
          isUploading.value = true;
          setStatus('æ­£åœ¨ä¸Šä¼ å›¾ç‰‡â€¦', 'ok');
          const fd = new FormData();
          fd.append('token', token.value);
          selectedFiles.value.forEach(item => fd.append('files', item.raw, item.name));

          const rUpload = await fetch(API + '/api/upload', { method: 'POST', body: fd });
          const jUpload = await rUpload.json().catch(() => ({}));
          if (!rUpload.ok) throw new Error(jUpload.error || 'ä¸Šä¼ å¤±è´¥');
          if (!jUpload.session_id) throw new Error('ä¸Šä¼ æˆåŠŸä½†ç¼ºå°‘ session_idï¼Œè¯·æ£€æŸ¥åç«¯å®ç°ã€‚');
          uploadSessionId.value = jUpload.session_id;

          isUploading.value = false;
          setStatus('ä¸Šä¼ æˆåŠŸï¼Œå¼€å§‹æ£€æµ‹â€¦', 'ok');

          // 2) æ£€æµ‹ï¼šå¸¦ session_id
          isPredicting.value = true;
          const fdPredict = new FormData();
          fdPredict.append('token', token.value);
          fdPredict.append('session_id', uploadSessionId.value);
          fdPredict.append('conf', String(conf.value));

          const rPredict = await fetch(API + '/api/predict', { method: 'POST', body: fdPredict });
          const j = await rPredict.json().catch(() => ({}));
          if (!rPredict.ok) throw new Error(j.error || 'æ£€æµ‹å¤±è´¥');

          detections.value = j.detections || [];
          setStatus(`æ£€æµ‹å®Œæˆï¼Œå…± ${detections.value.length} å¼ ç»“æœã€‚`, 'ok');
        } catch (err) {
          console.error(err);
          setStatus(err.message || String(err), 'error');
        } finally {
          isUploading.value = false;
          isPredicting.value = false;
        }
      };

      // ========= ä»æœåŠ¡å™¨åŠ è½½å†å²è¯¦æƒ… =========
      const loadHistoryById = async (id) => {
        if (!token.value) return setStatus('ç™»å½•çŠ¶æ€å¤±æ•ˆã€‚', 'error');
        if (!id) return;

        try {
          setStatus('æ­£åœ¨åŠ è½½å†å²è®°å½•è¯¦æƒ…â€¦', 'ok');
          const url = API + '/api/history/' + id + '?token=' + encodeURIComponent(token.value);
          const r = await fetch(url);
          const j = await r.json().catch(() => ({}));
          if (!r.ok) throw new Error(j.error || 'åŠ è½½å†å²è¯¦æƒ…å¤±è´¥');

          detections.value = j.detections || [];
          currentHistoryId.value = Number(id);
          currentHistoryTime.value = j.time || '';

          // æ»šåˆ°ç»“æœé¢æ¿
          setTimeout(() => {
            const panel = document.querySelector('.result-panel');
            if (panel) panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }, 0);

          setStatus('å·²åŠ è½½ä¸€æ¡å†å²æ£€æµ‹ç»“æœã€‚', 'ok');
        } catch (err) {
          console.error(err);
          setStatus(err.message || String(err), 'error');
        }
      };

      // ========= å¯¼å‡ºï¼šé€‰æ‹©æ–‡ä»¶å¤¹ï¼ˆElectronï¼‰ =========
      const exportDetections = async ({ suggestedName, dets, meta }) => {
        // 1) æ£€æŸ¥ Electron bridge
        if (!window.tofd || typeof window.tofd.exportDetections !== 'function') {
          return setStatus('å¯¼å‡ºåŠŸèƒ½ä»…åœ¨æ¡Œé¢å®¢æˆ·ç«¯å¯ç”¨ï¼ˆè¯·ç¡®è®¤å·²é…ç½® preload.js / ipcMainï¼‰ã€‚', 'error');
        }
        // 2) å» Proxyï¼šå¦åˆ™ä¼šæŠ¥ An object could not be cloned.
        const plain = JSON.parse(JSON.stringify(dets || []));
        try {
          const res = await window.tofd.exportDetections({
            apiBase: API,
            suggestedName,
            detections: plain,
            meta: meta || {}
          });
          if (res && res.canceled) return;
          if (!res || !res.ok) throw new Error((res && res.error) || 'å¯¼å‡ºå¤±è´¥');
          setStatus(`å¯¼å‡ºæˆåŠŸï¼šå·²ä¿å­˜ ${res.saved || 0} å¼ `, 'ok');
        } catch (e) {
          console.error(e);
          setStatus(e.message || String(e), 'error');
        }
      };

      const exportCurrent = async () => {
        if (!detections.value.length) return setStatus('å½“å‰æ²¡æœ‰å¯å¯¼å‡ºçš„ç»“æœã€‚', 'error');

        const name = currentHistoryId.value
          ? `history_${currentHistoryId.value}`
          : `session_${uploadSessionId.value || 'current'}`;

        await exportDetections({
          suggestedName: name,
          dets: detections.value,
          meta: {
            username: username.value,
            source: currentHistoryId.value ? 'history' : 'current',
            history_id: currentHistoryId.value,
            history_time: currentHistoryTime.value,
            session_id: uploadSessionId.value,
            conf: conf.value
          }
        });
      };

      const exportAsHistory = async () => {
        if (!currentHistoryId.value) return setStatus('å½“å‰å±•ç¤ºçš„ä¸æ˜¯å†å²è®°å½•ã€‚', 'error');
        await exportCurrent();
      };

      const onImageError = (idx) => console.warn('å›¾ç‰‡åŠ è½½å¤±è´¥', idx);

      const logout = () => {
        localStorage.removeItem('yolo_token');
        localStorage.removeItem('yolo_user');
        localStorage.removeItem('yolo_role');
        location.href = 'index.html';
      };
      const goLogin = () => { location.href = 'index.html'; };
      const goHistory = () => { location.href = 'history.html'; };
      const goMain = () => { location.href = 'main.html'; };

      // âœ… æ¥åŠ›ï¼šhistory é¡µç‚¹â€œåœ¨æ£€æµ‹é¡µæŸ¥çœ‹â€åï¼Œmain é¡µè‡ªåŠ¨åŠ è½½
      onMounted(async () => {
        const pendingId = localStorage.getItem('tofd_open_history_id');
        if (pendingId) {
          localStorage.removeItem('tofd_open_history_id');
          await loadHistoryById(pendingId);
        }
      });

      return {
        username, token,
        selectedFiles, dragOver, fileInput,
        isUploading, isPredicting, isBusy,
        statusMessage, statusType,
        conf, detections, showAdvanced,
        previewImage,
        API,
        currentHistoryId,
        viewSourceText,

        openZoom, closeZoom,
        openFileDialog, onFileChange, onFolderChange,
        onDragOver, onDragLeave, onDrop,
        addFiles, removeFile, scrollToResult,
        runDetection, decodeImageUrl, onImageError,

        exportCurrent, exportAsHistory,

        logout, goLogin, goHistory, goSettings, goMain,
        humanSize
      };
    }
  }).mount('#app');
</script>
</body>
</html>
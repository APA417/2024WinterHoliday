<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>设置 - TOFD 焊缝缺陷检测</title>

  <script src="./config.js"></script>

   <script src="./libs/vue.global.prod.js"></script>
  <link rel="stylesheet" href="main.css">
</head>
<body>
<div id="app">
  <header class="app-header">
    <div class="app-title">
      <div>
        <h1>设置</h1>
        <p class="subtitle">固定服务器地址（局域网 C/S），提供连接检测</p>
      </div>
    </div>
    <div class="user-area">
      <span class="user-name">您好，{{ username }}</span>
      <button class="link-btn" @click="logout">退出登录</button>
    </div>
  </header>

  <nav class="top-nav" v-if="token">
    <button class="nav-btn" :class="{active: isActive('profile.html')}" @click="go('profile.html')">首页</button>
    <button class="nav-btn" :class="{active: isActive('main.html')}" @click="go('main.html')">开始检测</button>
    <button class="nav-btn" :class="{active: isActive('history.html')}" @click="go('history.html')">历史记录</button>
    <button class="nav-btn" :class="{active: isActive('settings.html')}" @click="go('settings.html')">设置</button>
  </nav>

  <main class="app-main" v-if="token">
    <section class="panel">
      <h2 class="panel-title">服务器连接</h2>
      <div class="kv">
        <div><span class="k">服务器地址</span><span class="v">{{ API }}</span></div>
        <div><span class="k">连接状态</span>
          <span class="v" :style="{color: ok ? 'var(--success)' : 'var(--danger)'}">
            {{ ok === null ? '未检测' : (ok ? '正常' : '异常') }}
          </span>
        </div>
      </div>

      <div class="soft-actions" style="margin-top:14px;">
        <button class="btn-soft" @click="test" :disabled="loading">{{ loading ? '检测中…' : '测试连接' }}</button>
        <button class="btn-soft" @click="openDocs">打开接口文档</button>
      </div>

      <p v-if="msg" class="status-banner" :class="ok ? 'ok' : 'error'">{{ msg }}</p>

      <h2 class="panel-title" style="margin-top:22px;">客户端导出</h2>
      <div class="kv">
        <div><span class="k">导出功能</span><span class="v">{{ hasExporter ? '已接入（Electron）' : '未接入' }}</span></div>
        <div><span class="k">说明</span><span class="v">导出会把结果图片与 JSON 保存到本机（用于归档/离线查看）</span></div>
      </div>
    </section>

    <section class="panel result-panel">
      <h2 class="panel-title">使用建议（局域网 C/S）</h2>
      <ul class="tips">
        <li>客户端只需连接服务器：上传→服务端检测→结果/历史统一保存在服务器。</li>
        <li>客户端“导出”仅用于本地留档，不影响服务器共享历史。</li>
        <li>如遇图片加载失败：检查服务器是否能访问 <code>/runs/...</code> 静态资源。</li>
      </ul>
    </section>
  </main>

  <main class="app-main" v-else>
    <section class="panel">
      <h2>登录状态已失效</h2>
      <button class="btn-primary" @click="goLogin">返回登录页</button>
    </section>
  </main>
</div>

<script>
  const { createApp, ref, computed } = Vue;

  const API = (window.__APP_CONFIG__ && window.__APP_CONFIG__.API_BASE)
    ? window.__APP_CONFIG__.API_BASE
    : "http://127.0.0.1:8000";

  createApp({
    setup() {
      const username = ref(localStorage.getItem('yolo_user') || '用户');
      const token = ref(localStorage.getItem('yolo_token') || '');
      const ok = ref(null);
      const msg = ref('');
      const loading = ref(false);

      const hasExporter = computed(() => !!(window.tofd && typeof window.tofd.exportDetections === 'function'));

      const isActive = (page) => ((location.pathname || '').split('/').pop() || '') === page;
      const go = (page) => location.href = page;

      const requireAuth = () => { if (!token.value) location.href = 'index.html'; };

      const test = async () => {
        loading.value = true;
        msg.value = '';
        ok.value = null;
        try {
          // FastAPI 默认有 /openapi.json，可用于最轻量的健康检查
          const r = await fetch(API.replace(/\/+$/, '') + '/openapi.json', { method: 'GET' });
          ok.value = r.ok;
          msg.value = r.ok ? '连接正常：服务器可访问。' : '连接异常：无法访问 openapi.json。';
        } catch(e) {
          ok.value = false;
          msg.value = '连接异常：' + (e.message || String(e));
        } finally {
          loading.value = false;
        }
      };

      const openDocs = () => {
        const u = API.replace(/\/+$/, '') + '/docs';
        window.open(u);
      };

      const logout = () => {
        localStorage.removeItem('yolo_token');
        localStorage.removeItem('yolo_user');
        localStorage.removeItem('yolo_role');
        location.href = 'index.html';
      };
      const goLogin = () => { location.href = 'index.html'; };

      requireAuth();

      return { username, token, API, ok, msg, loading, hasExporter, isActive, go, test, openDocs, logout, goLogin };
    }
  }).mount('#app');
</script>

<style>
  .kv{display:flex;flex-direction:column;gap:10px;}
  .kv .k{display:inline-block;min-width:90px;color:var(--ink-light);font-size:13px;}
  .kv .v{font-weight:600;color:var(--ink);}
  .tips{margin:0;padding-left:18px;color:var(--ink);line-height:1.8;}
  .tips code{background:#f1f3f5;padding:2px 6px;border-radius:6px;border:1px solid #e6e6e6;}
</style>
</body>
</html>